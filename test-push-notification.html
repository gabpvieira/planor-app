<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste Push Notifications - Planor</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: #0a0a0a;
      color: #fafafa;
    }
    h1 { color: #3b82f6; }
    .card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status.granted { background: #22c55e20; color: #22c55e; }
    .status.denied { background: #ef444420; color: #ef4444; }
    .status.default { background: #6b728020; color: #6b7280; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover { background: #2563eb; }
    button:disabled { background: #333; cursor: not-allowed; }
    button.secondary { background: #333; }
    button.secondary:hover { background: #444; }
    pre {
      background: #111;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
    }
    .log { color: #6b7280; font-size: 12px; margin: 5px 0; }
    .log.success { color: #22c55e; }
    .log.error { color: #ef4444; }
  </style>
</head>
<body>
  <h1>üîî Teste Push Notifications</h1>
  
  <div class="card">
    <h3>Status do Navegador</h3>
    <p>Service Worker: <span id="sw-status" class="status default">Verificando...</span></p>
    <p>Push Manager: <span id="push-status" class="status default">Verificando...</span></p>
    <p>Permiss√£o: <span id="permission-status" class="status default">Verificando...</span></p>
    <p>Subscription: <span id="subscription-status" class="status default">Verificando...</span></p>
  </div>

  <div class="card">
    <h3>A√ß√µes</h3>
    <button id="btn-permission" onclick="requestPermission()">Solicitar Permiss√£o</button>
    <button id="btn-subscribe" onclick="subscribe()">Inscrever</button>
    <button id="btn-unsubscribe" onclick="unsubscribe()" class="secondary">Cancelar Inscri√ß√£o</button>
    <button id="btn-test" onclick="sendTestNotification()">Testar Notifica√ß√£o</button>
  </div>

  <div class="card">
    <h3>Subscription Data</h3>
    <pre id="subscription-data">Nenhuma subscription ativa</pre>
  </div>

  <div class="card">
    <h3>Log</h3>
    <div id="log"></div>
  </div>

  <script>
    // VAPID Public Key - substitua pela sua chave
    const VAPID_PUBLIC_KEY = 'BEhZJIJKT1GIw8EcfnlLGxTUgaoxJSwMXFi2myMKzU5D-fRSaVbymd-S36CDJsZ_GEEWkIma1CQXeMdlzrRrd94';
    
    let swRegistration = null;
    let pushSubscription = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const p = document.createElement('p');
      p.className = `log ${type}`;
      p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.insertBefore(p, logDiv.firstChild);
      console.log(message);
    }

    function updateStatus(id, status, text) {
      const el = document.getElementById(id);
      el.className = `status ${status}`;
      el.textContent = text;
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    async function checkStatus() {
      // Service Worker
      if ('serviceWorker' in navigator) {
        updateStatus('sw-status', 'granted', 'Suportado');
        try {
          swRegistration = await navigator.serviceWorker.ready;
          log('Service Worker pronto', 'success');
        } catch (e) {
          log('Erro ao obter Service Worker: ' + e.message, 'error');
        }
      } else {
        updateStatus('sw-status', 'denied', 'N√£o suportado');
        log('Service Worker n√£o suportado', 'error');
      }

      // Push Manager
      if ('PushManager' in window) {
        updateStatus('push-status', 'granted', 'Suportado');
      } else {
        updateStatus('push-status', 'denied', 'N√£o suportado');
        log('Push Manager n√£o suportado', 'error');
      }

      // Permission
      if ('Notification' in window) {
        const permission = Notification.permission;
        updateStatus('permission-status', permission, permission);
      } else {
        updateStatus('permission-status', 'denied', 'N√£o suportado');
      }

      // Subscription
      await checkSubscription();
    }

    async function checkSubscription() {
      if (!swRegistration) return;
      
      try {
        pushSubscription = await swRegistration.pushManager.getSubscription();
        if (pushSubscription) {
          updateStatus('subscription-status', 'granted', 'Ativo');
          document.getElementById('subscription-data').textContent = 
            JSON.stringify(pushSubscription.toJSON(), null, 2);
          log('Subscription encontrada', 'success');
        } else {
          updateStatus('subscription-status', 'default', 'N√£o inscrito');
          document.getElementById('subscription-data').textContent = 'Nenhuma subscription ativa';
        }
      } catch (e) {
        log('Erro ao verificar subscription: ' + e.message, 'error');
      }
    }

    async function requestPermission() {
      log('Solicitando permiss√£o...');
      try {
        const permission = await Notification.requestPermission();
        updateStatus('permission-status', permission, permission);
        log(`Permiss√£o: ${permission}`, permission === 'granted' ? 'success' : 'error');
      } catch (e) {
        log('Erro ao solicitar permiss√£o: ' + e.message, 'error');
      }
    }

    async function subscribe() {
      if (!swRegistration) {
        log('Service Worker n√£o dispon√≠vel', 'error');
        return;
      }

      log('Inscrevendo...');
      try {
        pushSubscription = await swRegistration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });
        
        updateStatus('subscription-status', 'granted', 'Ativo');
        document.getElementById('subscription-data').textContent = 
          JSON.stringify(pushSubscription.toJSON(), null, 2);
        log('Inscrito com sucesso!', 'success');
        
        // Aqui voc√™ enviaria a subscription para o servidor
        log('Subscription pronta para enviar ao servidor');
      } catch (e) {
        log('Erro ao inscrever: ' + e.message, 'error');
      }
    }

    async function unsubscribe() {
      if (!pushSubscription) {
        log('Nenhuma subscription ativa', 'error');
        return;
      }

      log('Cancelando inscri√ß√£o...');
      try {
        await pushSubscription.unsubscribe();
        pushSubscription = null;
        updateStatus('subscription-status', 'default', 'N√£o inscrito');
        document.getElementById('subscription-data').textContent = 'Nenhuma subscription ativa';
        log('Inscri√ß√£o cancelada', 'success');
      } catch (e) {
        log('Erro ao cancelar: ' + e.message, 'error');
      }
    }

    async function sendTestNotification() {
      if (!swRegistration) {
        log('Service Worker n√£o dispon√≠vel', 'error');
        return;
      }

      log('Enviando notifica√ß√£o de teste...');
      try {
        await swRegistration.showNotification('Planor - Teste', {
          body: 'Suas notifica√ß√µes est√£o funcionando! üéâ',
          icon: '/icons/icon-192x192.png',
          badge: '/icons/icon-96x96.png',
          tag: 'test-' + Date.now(),
          data: { url: '/app' }
        });
        log('Notifica√ß√£o enviada!', 'success');
      } catch (e) {
        log('Erro ao enviar notifica√ß√£o: ' + e.message, 'error');
      }
    }

    // Inicializar
    window.addEventListener('load', () => {
      log('P√°gina carregada, verificando status...');
      checkStatus();
    });
  </script>
</body>
</html>
